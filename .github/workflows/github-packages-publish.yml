name: GitHub Packages CI/CD
run-name: ${{ github.workflow }} for ${{ github.ref_name }} [${{ github.event_name }} ${{github.event.action}}] ${{ inputs.versionType }} ${{ inputs.publishTag }} [${{ github.sha }}]

on:
  pull_request:
    types: [opened, synchronize, labeled, reopened, closed]
    branches:
      - main
    paths:
      - 'src/**'
      - 'nuxt.config.ts'
      - 'package.json'
      - 'package-lock.json'
      - 'tsconfig.json'
      - '.github/workflows/github-packages-publish.yml'

  workflow_dispatch:
    inputs:
      versionType:
        description: |
          Type of version to publish (e.g., patch, minor, major, prepatch, preminor, premajor)
        type: choice
        required: false
        default: prepatch
        options:
          - patch
          - minor
          - major
          - prepatch
          - preminor
          - premajor

      publishTag:
        description: |
          Publish tag for npm (choose from: latest, alpha, beta, next)
        type: choice
        required: false
        default: next
        options:
          - latest
          - alpha
          - beta
          - next

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    if: github.event_name == 'pull_request' && (github.event.action == 'opened' || github.event.action == 'synchronize' || github.event.action == 'reopened')
    uses: gawaooooo-sandbox/learn-github-actions-reusable-workflows/.github/workflows/lint.yml@v3
    permissions:
      contents: read
      packages: read

  test:
    if: github.event_name == 'pull_request' && (github.event.action == 'opened' || github.event.action == 'synchronize' || github.event.action == 'reopened')
    uses: ./.github/workflows/test.yml

  auto-version:
    if: github.event.action == 'labeled' && startsWith(github.event.label.name, 'release/')
    runs-on: ubuntu-22.04
    timeout-minutes: 5
    permissions:
      contents: write
    steps:
      - name: Npm Auto Bump
        uses: gawaooooo-sandbox/learn-github-actions-custom/composite/npm-auto-bump@v3
        with:
          checkout-ref: ${{ github.head_ref }}
          label-name: ${{ github.event.label.name }}

  publish-release-package:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-22.04
    timeout-minutes: 5
    permissions:
      contents: write
      packages: write
      pull-requests: read
    steps:
      - name: Publising Release Package
        uses: gawaooooo-sandbox/learn-github-actions-custom/composite/npm-release-publish@feature/npm-release-publish
        with:
          pr-number: ${{ github.event.pull_request.number }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

  publish-dev-package:
    # 手動ディスパッチトリガーは、開発用のブランチから開発用のパッケージを公開するときのみ使用できます。
    # 正式なリリースは、プルリクエストの自動マージによる公開で行います。
    if: github.event_name == 'workflow_dispatch' && github.ref != 'refs/heads/main'
    runs-on: ubuntu-22.04
    timeout-minutes: 5
    permissions:
      contents: write
      packages: write
    steps:
      - name: Publising Development Package
        uses: gawaooooo-sandbox/learn-github-actions-custom/composite/npm-dev-publish@v3
        with:
          version-type: ${{ inputs.versionType }}
          publish-tag: ${{ inputs.publishTag }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
